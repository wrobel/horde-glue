From: Gunnar Wrobel <p@rdus.de>
Subject: [PATCH] t/kronolith/HK/GW/SyncMLrefresh

Refresh calendars before running a SyncML synchronization.

Signed-off-by: Gunnar Wrobel <p@rdus.de>

---
 horde-webmail/kronolith/lib/Driver/kolab.php |   10 ++++++++++
 horde-webmail/kronolith/lib/api.php          |    3 +++
 2 files changed, 13 insertions(+), 0 deletions(-)

diff --git a/horde-webmail/kronolith/lib/Driver/kolab.php b/horde-webmail/kronolith/lib/Driver/kolab.php
index 6133d74..de49c81 100644
--- a/horde-webmail/kronolith/lib/Driver/kolab.php
+++ b/horde-webmail/kronolith/lib/Driver/kolab.php
@@ -62,6 +62,7 @@ class Kronolith_Driver_kolab extends Kronolith_Driver {
             $this->_calendar = $calendar;
             $this->_wrapper->reset();
         }
+        $this->_wrapper->open($calendar);
 
         return true;
     }
@@ -215,6 +216,10 @@ class Kronolith_Driver_kolab_wrapper {
         $this->_driver = &$driver;
         $this->_kolab = &$driver->_kolab;
     }
+
+    function open($calendar)
+    {
+    }
 }
 
 
@@ -991,6 +996,11 @@ class Kronolith_Driver_kolab_wrapper_new extends Kronolith_Driver_kolab_wrapper
         $this->reset();
     }
 
+    function open($calendar)
+    {
+        $this->synchronize();
+    }
+
     /**
      * Reset internal variable on share change
      */
diff --git a/horde-webmail/kronolith/lib/api.php b/horde-webmail/kronolith/lib/api.php
index 68a52d0..202b85e 100644
--- a/horde-webmail/kronolith/lib/api.php
+++ b/horde-webmail/kronolith/lib/api.php
@@ -694,6 +694,7 @@ function _kronolith_list($calendar = null, $startstamp = 0, $endstamp = 0)
 function _kronolith_listBy($action, $timestamp, $calendar = null)
 {
     require_once dirname(__FILE__) . '/base.php';
+    global $kronolith_driver;
 
     if (empty($calendar)) {
         $calendar = Kronolith::getDefaultCalendar();
@@ -704,6 +705,8 @@ function _kronolith_listBy($action, $timestamp, $calendar = null)
         return PEAR::raiseError(_("Permission Denied"));
     }
 
+    $kronolith_driver->open($calendar);
+
     $history = &Horde_History::singleton();
     $histories = $history->getByTimestamp('>', $timestamp, array(array('op' => '=', 'field' => 'action', 'value' => $action)), 'kronolith:' . $calendar);
     if (is_a($histories, 'PEAR_Error')) {
-- 
tg: (6938161..) t/kronolith/HK/GW/SyncMLrefresh (depends on: master)
-- 
TOPGIT patch commit log
=======================

commit d66c36f15b0ee0524d4cc2660ea8d092e82df1b2
Author: Gunnar Wrobel <p@rdus.de>
Date:   Sun Feb 1 23:54:50 2009 +0000

    Added patch kronolith/HK-GW-SyncML_refresh.patch   from the mercurial release queue.
