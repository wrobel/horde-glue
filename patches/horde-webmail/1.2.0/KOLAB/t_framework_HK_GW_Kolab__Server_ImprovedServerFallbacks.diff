From: Gunnar Wrobel <p@rdus.de>
Subject: [PATCH] t/framework/HK/GW/Kolab_Server/ImprovedServerFallbacks

Improved fallbacks for getServer().

Signed-off-by: Gunnar Wrobel <p@rdus.de>

---
 .../lib/Horde/Kolab/Server/Object/user.php         |   19 ++++++++++++++++---
 1 files changed, 16 insertions(+), 3 deletions(-)

diff --git a/horde-webmail/lib/Horde/Kolab/Server/Object/user.php b/horde-webmail/lib/Horde/Kolab/Server/Object/user.php
index 73e108d..76b202b 100644
--- a/horde-webmail/lib/Horde/Kolab/Server/Object/user.php
+++ b/horde-webmail/lib/Horde/Kolab/Server/Object/user.php
@@ -193,6 +193,8 @@ class Horde_Kolab_Server_Object_user extends Horde_Kolab_Server_Object {
      */
     function getServer($server_type)
     {
+        global $conf;
+
         switch ($server_type) {
         case 'freebusy':
             $server = $this->get(KOLAB_ATTR_FREEBUSYHOST);
@@ -203,7 +205,15 @@ class Horde_Kolab_Server_Object_user extends Horde_Kolab_Server_Object {
             if (is_a($server, 'PEAR_Error')) {
                 return $server;
             }
-            return 'https://' . $server . '/freebusy';
+            if (empty($server)) {
+                $server = $_SERVER['SERVER_NAME'];
+            }
+            if (isset($conf['kolab']['server']['freebusy_url_format'])) {
+                return sprintf($conf['kolab']['server']['freebusy_url_format'],
+                               $server);
+            } else {
+                return 'https://' . $server . '/freebusy';
+            }
         case 'imap':
             $server = $this->get(KOLAB_ATTR_IMAPHOST);
             if (!is_a($server, 'PEAR_Error') && !empty($server)) {
@@ -211,8 +221,11 @@ class Horde_Kolab_Server_Object_user extends Horde_Kolab_Server_Object {
             }
         case 'homeserver':
         default:
-            $home = $this->get(KOLAB_ATTR_HOMESERVER);
-            return $home;
+            $server = $this->get(KOLAB_ATTR_HOMESERVER);
+            if (empty($server)) {
+                $server = $_SERVER['SERVER_NAME'];
+            }
+            return $server;
         }
     }
 
-- 
tg: (2185342..) t/framework/HK/GW/Kolab_Server/ImprovedServerFallbacks (depends on: t/framework/HK/GW/Kolab_Server/ImprovedFreebusyServerFallback)
-- 
TOPGIT patch commit log
=======================

commit d0d1a70bc27ac4ae027e9bece298f957cf2f9102
Author: Gunnar Wrobel <p@rdus.de>
Date:   Sat Jan 31 00:26:41 2009 +0000

    Added patch framework/HK-GW-Kolab_Server-Fix_getServor_on_empty_homeserver.patch from the mercurial release queue.
