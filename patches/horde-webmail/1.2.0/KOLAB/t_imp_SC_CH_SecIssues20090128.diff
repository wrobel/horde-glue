From: Gunnar Wrobel <p@rdus.de>
Subject: [PATCH] t/imp/SC/CH/SecIssues20090128

Security issues patched on 20090128

Signed-off-by: Gunnar Wrobel <p@rdus.de>

---
 horde-webmail/imp/message.php |   10 +++++-----
 horde-webmail/imp/pgp.php     |    4 ++--
 horde-webmail/imp/smime.php   |    4 ++--
 3 files changed, 9 insertions(+), 9 deletions(-)

diff --git a/horde-webmail/imp/message.php b/horde-webmail/imp/message.php
index c822e0b..0488af7 100644
--- a/horde-webmail/imp/message.php
+++ b/horde-webmail/imp/message.php
@@ -444,7 +444,7 @@ if (!$printer_friendly && !empty($conf['maillog']['use_maillog'])) {
 
     /* Do MDN processing now. */
     if ($imp_ui->MDNCheck($ob->header, Util::getFormData('mdn_confirm'))) {
-        $confirm_link = Horde::link(Util::addParameter($selfURL, 'mdn_confirm', 1)) . _("HERE") . '</a>';
+        $confirm_link = Horde::link(htmlspecialchars(Util::addParameter($selfURL, 'mdn_confirm', 1))) . _("HERE") . '</a>';
         $notification->push(sprintf(_("The sender of this message is requesting a Message Disposition Notification from you when you have read this message. Please click %s to send the notification message."), $confirm_link), 'horde.message', array('content.raw'));
     }
 }
@@ -617,13 +617,13 @@ if (!$printer_friendly) {
 
     $a_template->set('headers', Horde::widget('#', _("Headers"), 'widget hasmenu', '', '', _("Headers"), true));
     if ($all_headers || $list_headers) {
-        $a_template->set('common_headers', Horde::widget($headersURL, _("Show Common Headers"), 'widget', '', '', _("Show Common Headers"), true));
+        $a_template->set('common_headers', Horde::widget(htmlspecialchars($headersURL), _("Show Common Headers"), 'widget', '', '', _("Show Common Headers"), true));
     }
     if (!$all_headers) {
-        $a_template->set('all_headers', Horde::widget(Util::addParameter($headersURL, 'show_all_headers', 1), _("Show All Headers"), 'widget', '', '', _("Show All Headers"), true));
+        $a_template->set('all_headers', Horde::widget(htmlspecialchars(Util::addParameter($headersURL, 'show_all_headers', 1)), _("Show All Headers"), 'widget', '', '', _("Show All Headers"), true));
     }
     if ($list_info['exists'] && !$list_headers) {
-        $a_template->set('list_headers', Horde::widget(Util::addParameter($headersURL, 'show_list_headers', 1), _("Show Mailing List Information"), 'widget', '', '', _("Show Mailing List Information"), true));
+        $a_template->set('list_headers', Horde::widget(htmlspecialchars(Util::addParameter($headersURL, 'show_list_headers', 1)), _("Show Mailing List Information"), 'widget', '', '', _("Show Mailing List Information"), true));
     }
 
     echo $a_template->fetch(IMP_TEMPLATES . '/message/navbar_actions.html');
@@ -681,7 +681,7 @@ if ($show_parts || ($downloadall_link && !$printer_friendly)) {
             $url = Horde::selfUrl(true);
             $url = Util::removeParameter($url, array('actionID'));
             $url = Util::addParameter($url, array('actionID' => 'strip_all', 'message_token' => $message_token));
-            $val .= '<br />' . Horde::link($url, _("Strip All Attachments"), null, null, "return window.confirm('" . addslashes(_("Are you sure you wish to PERMANENTLY delete all attachments?")) . "');") . _("Strip All Attachments") . ' ' . Horde::img('delete.png', _("Strip Attachments"), null, $registry->getImageDir('horde')) . '</a>';
+            $val .= '<br />' . Horde::link(htmlspecialchars($url), _("Strip All Attachments"), null, null, "return window.confirm('" . addslashes(_("Are you sure you wish to PERMANENTLY delete all attachments?")) . "');") . _("Strip All Attachments") . ' ' . Horde::img('delete.png', _("Strip Attachments"), null, $registry->getImageDir('horde')) . '</a>';
         }
     }
     $hdrs[] = array('name' => _("Part(s)"), 'val' => $val, 'i' => (++$i % 2));
diff --git a/horde-webmail/imp/pgp.php b/horde-webmail/imp/pgp.php
index 35c733c..e88e910 100644
--- a/horde-webmail/imp/pgp.php
+++ b/horde-webmail/imp/pgp.php
@@ -40,7 +40,7 @@ function _outputPassphraseDialog($secure_check, $symmetric = false)
     $t->set('symmetric', $symmetric);
     $t->set('submit_url', Util::addParameter(Horde::applicationUrl('pgp.php'), 'actionID', $symmetric ? 'process_symmetric_passphrase_dialog' : 'process_passphrase_dialog'));
     $t->set('reload', htmlspecialchars(Util::getFormData('reload')));
-    $t->set('action', Util::getFormData('passphrase_action'));
+    $t->set('action', htmlspecialchars(Util::getFormData('passphrase_action')));
     $t->set('locked_img', Horde::img('locked.png', _("PGP"), null, $GLOBALS['registry']->getImageDir('horde')));
     echo $t->fetch(IMP_TEMPLATES . '/pgp/passphrase.html');
 }
@@ -66,7 +66,7 @@ function _importKeyDialog($target)
 
 function _reloadWindow()
 {
-    Util::closeWindowJS('opener.focus();opener.location.href="' . Util::getFormData('reload') . '";');
+    Util::closeWindowJS('opener.focus();opener.location.href="' . htmlspecialchars(Util::getFormData('reload')) . '";');
 }
 
 function _getImportKey()
diff --git a/horde-webmail/imp/smime.php b/horde-webmail/imp/smime.php
index 6ba24c6..d05c454 100644
--- a/horde-webmail/imp/smime.php
+++ b/horde-webmail/imp/smime.php
@@ -63,7 +63,7 @@ function _outputPassphraseDialog($secure_check)
     $t->setOption('gettext', true);
     $t->set('submit_url', Util::addParameter(Horde::applicationUrl('smime.php'), 'actionID', 'process_passphrase_dialog'));
     $t->set('reload', htmlspecialchars(html_entity_decode(Util::getFormData('reload'))));
-    $t->set('action', Util::getFormData('passphrase_action'));
+    $t->set('action', htmlspecialchars(Util::getFormData('passphrase_action')));
     $t->set('locked_img', Horde::img('locked.png', _("S/MIME"), null, $GLOBALS['registry']->getImageDir('horde')));
     echo $t->fetch(IMP_TEMPLATES . '/smime/passphrase.html');
 }
@@ -79,7 +79,7 @@ function _actionWindow()
 
 function _reloadWindow()
 {
-    Util::closeWindowJS('opener.focus();opener.location.href="' . Util::getFormData('reload') . '";');
+    Util::closeWindowJS('opener.focus();opener.location.href="' . htmlspecialchars(Util::getFormData('reload')) . '";');
 }
 
 function _textWindowOutput($filename, $msg, $html = false)
-- 
tg: (6938161..) t/imp/SC/CH/SecIssues20090128 (depends on: master)
-- 
TOPGIT patch commit log
=======================

commit a6149778434f9d0c94bd4bbf2b7b8cb15ed8135e
Author: Gunnar Wrobel <p@rdus.de>
Date:   Fri Feb 6 06:39:50 2009 +0000

    Security fixes from 20090128.
